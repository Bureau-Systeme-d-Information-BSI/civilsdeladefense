- full_name = @job_application.user.full_name
.activity{id: dom_id(@job_application, 'activity')}
  .font-weight-bold.text-secondary.mb-3
    = fa_icon('forum', class: 'text-secondary')
    = t('.title_state')

  .btn-group.mt-0.w-100
    - if can? :manage, @job_application
      = link_to @job_application.aasm.human_state, "#", class: "btn btn-raised dropdown-toggle w-100 d-flex", style: 'text-align:left;', data: {toggle: :dropdown}, aria: {haspopup: true, expanded: false}
      .dropdown-menu
        - @job_application.aasm.states.map(&:name).each do |state|
          - klasses = %w(dropdown-item)
          - klasses << 'disabled' if @job_application.state.to_sym == state
          = link_to JobApplication.human_attribute_name("state/#{ state }"), [:change_state, :admin, @job_application, {state: state}], method: :patch, remote: true, class: klasses
    - else
      = link_to @job_application.aasm.human_state, "#", class: "btn btn-raised w-100 text-left"
  - if @job_application.rejected_state?
    = simple_form_for [:admin, @job_application], remote: true, html: {class: 'mt-2 auto-submit'} do |f|
      = f.input :rejection_reason_id, collection: RejectionReason.all, label: false, prompt: :translate

  .font-weight-bold.text-secondary.mb-3.mt-4
    = fa_icon('forum', class: 'text-secondary')
    = t('.title')

  - if can? :manage, Message
    = render partial: '/admin/messages/form'

  %ul.list-unstyled.activities
    - ary = @job_application.audits + @job_application.associated_audits
    - audits = ary.sort_by(&:created_at).reverse!
    - audits.each do |audit|
      - audited_changes = audit.audited_changes
      - whodunnit = audit.try(:user).try(:full_name) || 'N/A'
      %li
        .d-flex
          - model = audit.auditable_type == 'JobApplication' && audit.version == 1 ? @job_application : audit.user
          - photo_obj = model == "unknown" ? nil : (model.is_a?(JobApplication) ? model.user.photo : model&.photo)
          = image_user_tag photo_obj, width: 32, class: 'photo'
          .d-flex.flex-column
            .mb-1
              - if audit.version == 1 && audit.auditable_type == 'JobApplication'
                = t('.activities.creation_html', name: full_name)
              - elsif audited_changes.key?('state')
                - state_name = JobApplication.states.key(audited_changes['state'].last)

                - state_name_i18n = JobApplication.human_attribute_name("state/#{state_name}")
                = t('.activities.change_state_html', admin_name: whodunnit, name: full_name, state_name: state_name_i18n)
              - elsif audit.auditable_type == "Message"
                = t('.activities.message_html', admin_name: whodunnit, name: full_name)
                .card.my-2
                  .card-body= audited_changes['body']
              - elsif audit.auditable_type == "Email" && audit.auditable.automatic_email?
                = t('.activities.email_automatic_html', name: full_name)
              - elsif audit.auditable_type == "Email" && (klass = audit.user.class.to_s) && %w(Administrator User NilClass).include?(klass)
                - if klass == "Administrator"
                  = t('.activities.email_html', admin_name: whodunnit, name: full_name)
                - elsif klass == "User"
                  = t('.activities.email_simple_html', from_name: whodunnit)
              - elsif audited_changes.key?('photo_updated_at')
                = t('.activities.updated_photo_html', admin_name: whodunnit, name: full_name)
              - else
                %code= audited_changes
            %small.text-muted.time-ago
              il y a #{time_ago_in_words audit.created_at}
